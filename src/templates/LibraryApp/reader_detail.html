{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="card">
    <h2>üé´ {{ page_title }}</h2>
    
    <!-- Th√¥ng tin th·∫ª ƒë·ªôc gi·∫£ -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 15px 0; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
            üìá TH√îNG TIN TH·∫∫ ƒê·ªòC GI·∫¢
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <strong>M√£ ƒë·ªôc gi·∫£:</strong><br>
                <span style="font-size: 1.2em;">{{ reader.id }}</span>
            </div>
            <div>
                <strong>Lo·∫°i ƒë·ªôc gi·∫£:</strong><br>
                <span style="font-size: 1.2em;">{{ reader.reader_type.reader_type_name }}</span>
            </div>
        </div>
    </div>
    
    <!-- Th√¥ng tin c√° nh√¢n -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #2c3e50; margin-top: 0;">üë§ Th√¥ng tin c√° nh√¢n</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 12px; font-weight: bold; width: 200px;">H·ªç v√† t√™n:</td>
                <td style="padding: 12px;">{{ reader.reader_name }}</td>
            </tr>
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 12px; font-weight: bold;">Ng√†y sinh:</td>
                <td style="padding: 12px;">{{ reader.date_of_birth|date:"d/m/Y" }} 
                    <span style="color: #666;">({{ reader.age }} tu·ªïi)</span>
                </td>
            </tr>
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 12px; font-weight: bold;">Email:</td>
                <td style="padding: 12px;">{{ reader.email }}</td>
            </tr>
            <tr>
                <td style="padding: 12px; font-weight: bold;">ƒê·ªãa ch·ªâ:</td>
                <td style="padding: 12px;">{{ reader.address|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</td>
            </tr>
        </table>
    </div>
    
    <!-- Th√¥ng tin th·∫ª -->
    <div style="background: #e8f4f8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #2980b9; margin-top: 0;">üìÖ Th√¥ng tin th·∫ª th∆∞ vi·ªán</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid #b3d9e6;">
                <td style="padding: 12px; font-weight: bold; width: 200px;">Ng√†y l·∫≠p th·∫ª:</td>
                <td style="padding: 12px;">{{ reader.card_creation_date|date:"d/m/Y" }}</td>
            </tr>
            <tr style="border-bottom: 1px solid #b3d9e6;">
                <td style="padding: 12px; font-weight: bold;">Ng√†y h·∫øt h·∫°n:</td>
                <td style="padding: 12px;">
                    {{ reader.expiration_date|date:"d/m/Y" }}
                    {% if reader.is_card_expired %}
                        <span style="color: #c62828; font-weight: bold;">‚ö†Ô∏è ƒê√É H·∫æT H·∫†N</span>
                    {% else %}
                        <span style="color: #27ae60; font-weight: bold;">‚úÖ C√íN H·∫†N</span>
                    {% endif %}
                </td>
            </tr>
            <tr style="border-bottom: 1px solid #b3d9e6;">
                <td style="padding: 12px; font-weight: bold;">Tr·∫°ng th√°i:</td>
                <td style="padding: 12px;">
                    {% if reader.is_active %}
                        <span style="background: #27ae60; color: white; padding: 5px 15px; border-radius: 20px;">
                            ‚úÖ ƒêang ho·∫°t ƒë·ªông
                        </span>
                    {% else %}
                        <span style="background: #e74c3c; color: white; padding: 5px 15px; border-radius: 20px;">
                            ‚ùå ƒê√£ kh√≥a
                        </span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td style="padding: 12px; font-weight: bold;">T·ªïng n·ª£:</td>
                <td style="padding: 12px;">
                    <span style="font-size: 1.2em; font-weight: bold; color: {% if reader.total_debt > 0 %}#c62828{% else %}#27ae60{% endif %};">
                        {{ reader.total_debt|floatformat:0|default:"0" }}ƒë
                    </span>
                </td>
            </tr>
        </table>
    </div>
    
    <!-- Th√¥ng tin m∆∞·ª£n s√°ch -->
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #856404; margin-top: 0;">
            <i class="fas fa-book"></i> S√°ch ƒëang m∆∞·ª£n
        </h3>
        <div id="readerBorrowingList" style="min-height: 200px;">
            <div style="text-align: center; color: #999;">
                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i danh s√°ch...
            </div>
        </div>
    </div>
    
    <!-- Action buttons -->
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <a href="{% url 'reader_create' %}" class="btn" style="flex: 1; text-align: center;">
            ‚ûï L·∫≠p th·∫ª ƒë·ªôc gi·∫£ kh√°c
        </a>
        <a href="{% url 'reader_list' %}" class="btn btn-secondary" style="flex: 1; text-align: center;">
            üìã Danh s√°ch ƒë·ªôc gi·∫£
        </a>
        <a href="{% url 'home' %}" class="btn btn-secondary" style="flex: 1; text-align: center;">
            üè† Trang ch·ªß
        </a>
    </div>
</div>

<style>
    .reader-borrow-item {
        padding: 12px;
        border-left: 4px solid #ffc107;
        background-color: #fffbf0;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    
    .reader-borrow-item.overdue {
        border-left-color: #dc3545;
        background-color: #ffe5e5;
    }
    
    .reader-borrow-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    
    .reader-borrow-table th {
        background-color: #f8f9fa;
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
    
    .reader-borrow-table td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .reader-borrow-table tr:hover {
        background-color: #f8f9fa;
    }
    
    .reader-borrow-table tr.overdue {
        background-color: #ffe5e5;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .badge-success {
        background-color: #d4edda;
        color: #155724;
    }
    
    .badge-danger {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }
</style>

<script>
function loadReaderBorrowingInfo() {
    const readerId = {{ reader.id }};
    
    fetch("{% url 'api_borrowing_readers' %}")
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => {
            const container = document.getElementById('readerBorrowingList');
            
            // T√¨m ƒë·ªôc gi·∫£ hi·ªán t·∫°i trong danh s√°ch
            const readerData = data.data?.find(r => r.reader_id == readerId);
            
            if (!readerData) {
                container.innerHTML = '<div style="text-align: center; color: #27ae60;"><em>‚úì ƒê·ªôc gi·∫£ kh√¥ng c√≥ s√°ch m∆∞·ª£n</em></div>';
            } else {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let booksHtml = readerData.books.map(book => {
                    const [day, month, year] = book.due_date.split('/');
                    const dueDate = new Date(year, month - 1, day);
                    const isOverdue = dueDate < today;
                    
                    return `
                        <tr ${isOverdue ? 'class="overdue"' : ''}>
                            <td><strong>${book.title}</strong></td>
                            <td>${book.borrow_date}</td>
                            <td>${book.due_date}</td>
                            <td>
                                ${isOverdue ? 
                                    '<span class="badge badge-danger">‚ö†Ô∏è Qu√° h·∫°n</span>' : 
                                    '<span class="badge badge-success">‚úì C√≤n h·∫°n</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong style="color: #856404;">T·ªïng s√°ch ƒëang m∆∞·ª£n:</strong><br>
                            <span style="font-size: 1.5em; color: #007bff; font-weight: bold;">${readerData.borrowed_count} quy·ªÉn</span>
                        </div>
                        <div>
                            <strong style="color: #856404;">Ph·∫£i tr·∫£ tr∆∞·ªõc:</strong><br>
                            <span style="font-size: 1.2em; font-weight: bold; color: ${readerData.is_overdue ? '#dc3545' : '#27ae60'};">
                                ${readerData.latest_due_date}
                                ${readerData.is_overdue ? ' ‚ö†Ô∏è' : ''}
                            </span>
                        </div>
                    </div>
                    
                    <table class="reader-borrow-table">
                        <thead>
                            <tr>
                                <th>T√™n s√°ch</th>
                                <th>Ng√†y m∆∞·ª£n</th>
                                <th>Ph·∫£i tr·∫£</th>
                                <th>Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${booksHtml}
                        </tbody>
                    </table>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading borrowing info:', error);
            document.getElementById('readerBorrowingList').innerHTML = '<div style="color: #c62828;"><em>L·ªói t·∫£i th√¥ng tin m∆∞·ª£n s√°ch</em></div>';
        });
}

// Load data khi trang load
document.addEventListener('DOMContentLoaded', function() {
    loadReaderBorrowingInfo();
    
    // Refresh m·ªói 30 gi√¢y
    setInterval(loadReaderBorrowingInfo, 30000);
});
</script>
{% endblock %}
