{% extends 'base.html' %}

{% block title %}Nh·∫≠n tr·∫£ s√°ch{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">
        ‚Ü©Ô∏è Nh·∫≠n tr·∫£ s√°ch
    </h1>
    <p class="text-gray-500">BM5 - Phi·∫øu Tr·∫£ S√°ch</p>
</div>

<!-- Messages -->
{% if messages %}
    {% for message in messages %}
        <div class="{% if message.tags == 'success' %}bg-green-50 border-l-4 border-green-500 text-green-700{% elif message.tags == 'error' %}bg-red-50 border-l-4 border-red-500 text-red-700{% else %}bg-blue-50 border-l-4 border-blue-500 text-blue-700{% endif %} p-4 rounded mb-6 flex justify-between items-start">
            <div class="flex items-center gap-2">
                {% if message.tags == 'success' %}‚úÖ{% elif message.tags == 'error' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
                <span>{{ message }}</span>
            </div>
            <button type="button" onclick="this.parentElement.remove()" class="text-current opacity-50 hover:opacity-100 text-lg leading-none">√ó</button>
        </div>
    {% endfor %}
{% endif %}

{% comment %} <!-- Quy ƒë·ªãnh 5 -->
<div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
    <h5 class="font-semibold text-blue-800 mb-2">‚ÑπÔ∏è Qƒê5 - Ti·ªÅn ph·∫°t tr·∫£ tr·ªÖ</h5>
    <ul class="text-blue-700 space-y-1 text-sm">
        <li>‚úì M·ªói ng√†y tr·∫£ tr·ªÖ ph·∫°t <strong>{{ params.fine_rate|default:1000 }} ƒë·ªìng/ng√†y</strong></li>
        <li>‚úì Ti·ªÅn ph·∫°t ƒë∆∞·ª£c t√≠nh t·ª´ ng√†y ph·∫£i tr·∫£ ƒë·∫øn ng√†y th·ª±c tr·∫£</li>
        <li>‚úì Ti·ªÅn ph·∫°t s·∫Ω ƒë∆∞·ª£c c·ªông v√†o t·ªïng n·ª£ c·ªßa ƒë·ªôc gi·∫£</li>
    </ul>
</div> {% endcomment %}

<!-- Tab Navigation -->
<div class="border-b border-gray-200 mb-6">
    <nav class="flex gap-4" role="tablist">
        <button class="tab-btn active py-3 px-4 border-b-2 font-medium text-sm transition-colors border-blue-600 text-blue-600" data-target="content-return">
            ‚Ü©Ô∏è Tr·∫£ s√°ch
        </button>
        <button class="tab-btn py-3 px-4 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="content-history">
            üìú L·ªãch s·ª≠ tr·∫£
        </button>
    </nav>
</div>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Tab 1: Tr·∫£ s√°ch -->
    <div class="tab-pane active" id="content-return">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <div class="bg-blue-600 text-white px-4 py-3">
                        <h5 class="font-semibold">Nh·∫≠p th√¥ng tin tr·∫£ s√°ch</h5>
                    </div>
                    <div class="p-4">
                        <form method="post" id="returnForm">
                            {% csrf_token %}
                            
                            <!-- Step 1: Ch·ªçn ƒë·ªôc gi·∫£ -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">B∆∞·ªõc 1: Ch·ªçn ƒë·ªôc gi·∫£</label>
                                <div class="mb-2">
                                    <input type="text" id="readerSearch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="üîç T√¨m ki·∫øm ƒë·ªôc gi·∫£...">
                                </div>
                                <div id="readerList" class="border border-gray-200 rounded-lg max-h-60 overflow-y-auto bg-gray-50">
                                    <div class="text-center text-gray-500 p-3">
                                        <small><em>ƒêang t·∫£i danh s√°ch...</em></small>
                                    </div>
                                </div>
                                <div class="mt-2 p-2 bg-gray-100 rounded-lg hidden" id="selectedReaderDisplay">
                                    <small><strong>Ch·ªçn:</strong> <span id="selectedReaderName"></span></small>
                                </div>
                            </div>
                            
                            <!-- Step 2: Ch·ªçn s√°ch m∆∞·ª£n -->
                            <div class="mb-6 hidden" id="booksSection">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">B∆∞·ªõc 2: Ch·ªçn s√°ch m∆∞·ª£n (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                                <div id="booksList" class="max-h-72 overflow-y-auto border border-gray-200 p-3 rounded-lg">
                                    <div class="text-center text-gray-500">
                                        <em>Vui l√≤ng ch·ªçn ƒë·ªôc gi·∫£ tr∆∞·ªõc</em>
                                    </div>
                                </div>
                                <small class="text-gray-500 block mt-2">Danh s√°ch s√°ch ƒë·ªôc gi·∫£ ƒë√≥ m∆∞·ª£n nh∆∞ng ch∆∞a tr·∫£</small>
                            </div>
                            
                            <!-- Hidden fields -->
                            {{ form.reader_id }}
                            {{ form.book_item_ids }}
                            
                            <!-- Step 3: Ng√†y tr·∫£ -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">B∆∞·ªõc 3: Ng√†y tr·∫£</label>
                                {{ form.return_date }}
                                {% if form.return_date.errors %}
                                <div class="text-red-500 text-sm mt-1">
                                    {{ form.return_date.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- L·ªói -->
                            {% if form.non_field_errors %}
                            <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 rounded mb-4">
                                {{ form.non_field_errors.0 }}
                            </div>
                            {% endif %}
                            
                            <div class="mb-4">
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" id="submitBtn" disabled>
                                    <span id="submitBtnText">‚úì Ghi nh·∫≠n tr·∫£ s√°ch</span>
                                    <span id="submitBtnLoading" class="hidden">
                                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        ƒêang x·ª≠ l√Ω...
                                    </span>
                                </button>
                            </div>
                        </form>

                        <!-- Link quay l·∫°i -->
                        <div class="mt-4">
                            <a href="{% url 'home' %}" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                ‚Üê Quay l·∫°i
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div>
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <div class="bg-yellow-500 text-gray-900 px-4 py-3">
                        <h5 class="font-semibold">
                            ‚ÑπÔ∏è T√≥m t·∫Øt
                        </h5>
                    </div>
                    <div class="p-4 min-h-96" id="summaryPanel">
                        <div class="text-center text-gray-500">
                            <em>Ch·ªçn ƒë·ªôc gi·∫£ ƒë·ªÉ xem t√≥m t·∫Øt</em>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: L·ªãch s·ª≠ tr·∫£ -->
    <div class="tab-pane hidden" id="content-history">
        <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div class="bg-cyan-500 text-white px-4 py-3">
                <h5 class="font-semibold">
                    üìú Danh s√°ch phi·∫øu ƒë√£ tr·∫£
                </h5>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2"><strong>B·ªô l·ªçc:</strong></label>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-btn px-3 py-1 text-sm rounded-lg border transition-colors bg-blue-600 text-white border-blue-600" data-filter="all">T·∫•t c·∫£</button>
                        <button class="filter-btn px-3 py-1 text-sm rounded-lg border transition-colors border-green-500 text-green-700 hover:bg-green-50" data-filter="ontime">Tr·∫£ ƒë√∫ng h·∫°n</button>
                        <button class="filter-btn px-3 py-1 text-sm rounded-lg border transition-colors border-red-500 text-red-700 hover:bg-red-50" data-filter="overdue">Tr·∫£ qu√° h·∫°n</button>
                    </div>
                </div>
                <div id="historyList" class="overflow-x-auto min-h-96">
                    <div class="text-center text-gray-500 py-4">
                        <span class="animate-spin inline-block mr-2">‚è≥</span> ƒêang t·∫£i l·ªãch s·ª≠...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let readersData = {{ readers_json|safe }};
let paramsData = {{ params_json|safe }};
let selectedReader = null;
let selectedBooks = [];
let currentFilter = 'all';

// ============ TAB FUNCTIONALITY ============

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'border-blue-600', 'text-blue-600');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        
        this.classList.add('active', 'border-blue-600', 'text-blue-600');
        this.classList.remove('border-transparent', 'text-gray-500');
        
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        
        const target = this.dataset.target;
        document.getElementById(target).classList.remove('hidden');
        
        if (target === 'content-history') {
            loadReturnHistory(currentFilter);
        }
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadReaders();
    
    document.getElementById('readerSearch').addEventListener('input', function() {
        filterReaders(this.value.toLowerCase());
    });
    
    document.getElementById('id_return_date').addEventListener('change', function() {
        updateSubmitButton();
    });
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                b.classList.add('border-gray-300', 'text-gray-700');
            });
            this.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            this.classList.remove('border-gray-300', 'text-gray-700');
            currentFilter = this.dataset.filter;
            loadReturnHistory(currentFilter);
        });
    });
    
    loadReturnHistory();
});

function loadReaders() {
    const readerList = document.getElementById('readerList');
    if (!readersData.length) {
        readerList.innerHTML = '<div class="text-center text-gray-500 p-3"><small>Kh√¥ng c√≥ ƒë·ªôc gi·∫£</small></div>';
        return;
    }
    
    renderReadersList(readersData.slice(0, 5));
}

function renderReadersList(readers) {
    const readerList = document.getElementById('readerList');
    if (!readers.length) {
        readerList.innerHTML = '<div class="text-center text-gray-500 p-3"><small>Kh√¥ng t√¨m th·∫•y ƒë·ªôc gi·∫£</small></div>';
        return;
    }
    
    readerList.innerHTML = readers.map(reader => `
        <div class="reader-item p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-all" data-reader-id="${reader.id}">
            <div class="font-medium text-gray-900">${reader.reader_name}</div>
            <div class="text-sm text-gray-500">${reader.email}</div>
        </div>
    `).join('');
    
    document.querySelectorAll('.reader-item').forEach(item => {
        item.addEventListener('click', function() {
            selectReader(parseInt(this.dataset.readerId));
        });
    });
}

function filterReaders(query) {
    if (!query) {
        renderReadersList(readersData.slice(0, 5));
        return;
    }
    
    const filtered = readersData.filter(r => 
        r.reader_name.toLowerCase().includes(query) || 
        r.email.toLowerCase().includes(query)
    ).slice(0, 5);
    
    renderReadersList(filtered);
}

function selectReader(readerId) {
    selectedReader = readerId;
    selectedBooks = [];
    
    const reader = readersData.find(r => r.id === readerId);
    
    document.getElementById('readerSearch').value = '';
    document.getElementById('selectedReaderDisplay').classList.remove('hidden');
    document.getElementById('selectedReaderName').textContent = reader.reader_name + ' (' + reader.email + ')';
    
    document.getElementById('readerList').innerHTML = `
        <div class="text-center text-gray-500 p-2">
            <small>ƒê·ªôc gi·∫£ ƒë√£ ch·ªçn: <strong>${reader.reader_name}</strong></small>
        </div>
    `;
    
    loadReaderBooks(selectedReader);
    updateSummary();
}

function loadReaderBooks(readerId) {
    let url = `/api/reader/${readerId}/borrowed-books/`;
    
    fetch(url, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            renderBooks(data.data || []);
            document.getElementById('booksSection').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('booksList').innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 rounded">L·ªói t·∫£i danh s√°ch: ${error.message}</div>`;
        });
}

function renderBooks(books) {
    const booksList = document.getElementById('booksList');
    
    if (!books.length) {
        booksList.innerHTML = '<div class="text-center text-gray-500"><em>ƒê·ªôc gi·∫£ n√†y kh√¥ng c√≥ s√°ch m∆∞·ª£n ch∆∞a tr·∫£</em></div>';
        return;
    }
    
    booksList.innerHTML = books.map((book, idx) => `
        <div class="book-item p-3 border border-gray-200 rounded-lg mb-2 flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition-all ${book.is_overdue ? 'bg-yellow-50 border-yellow-400' : 'bg-gray-50'}" data-book-id="${book.book_item_id}">
            <input type="checkbox" class="book-checkbox w-5 h-5 cursor-pointer" value="${book.book_item_id}" onchange="updateSelectedBooks()">
            <div class="flex-1">
                <div class="font-medium text-gray-900">${book.book_title}</div>
                <div class="text-sm text-gray-500">
                    M∆∞·ª£n: ${book.borrow_date} | Ph·∫£i tr·∫£: ${book.due_date}
                    ${book.is_overdue ? `<span class="bg-yellow-400 text-gray-900 text-xs px-2 py-0.5 rounded-full ml-2">Qu√° h·∫°n ${book.days_overdue} ng√†y</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function updateSelectedBooks() {
    selectedBooks = [];
    document.querySelectorAll('.book-checkbox:checked').forEach(checkbox => {
        selectedBooks.push(parseInt(checkbox.value));
    });
    
    document.getElementById('id_reader_id').value = selectedReader || '';
    document.getElementById('id_book_item_ids').value = JSON.stringify(selectedBooks);
    
    updateSummary();
    updateSubmitButton();
}

function updateSummary() {
    if (!selectedReader) {
        document.getElementById('summaryPanel').innerHTML = '<div class="text-center text-gray-500"><em>Ch·ªçn ƒë·ªôc gi·∫£ ƒë·ªÉ xem t√≥m t·∫Øt</em></div>';
        return;
    }
    
    const reader = readersData.find(r => r.id === selectedReader);
    let html = `<div class="mb-4 pb-4 border-b border-gray-200">
        <strong class="text-gray-700">ƒê·ªôc gi·∫£:</strong><br>
        <span class="text-gray-900">${reader.reader_name}</span><br>
        <small class="text-gray-500">${reader.email}</small>
    </div>`;
    
    if (selectedBooks.length > 0) {
        const checkedBoxes = document.querySelectorAll('.book-checkbox:checked');
        
        html += `<div class="mb-4 pb-4 border-b border-gray-200">
            <strong class="text-gray-700">S√°ch tr·∫£ (${selectedBooks.length} quy·ªÉn):</strong><br>`;
        
        checkedBoxes.forEach(checkbox => {
            const bookItem = checkbox.closest('.book-item');
            const bookTitle = bookItem.querySelector('.font-medium').textContent;
            html += `<small class="text-gray-600">‚Ä¢ ${bookTitle}</small><br>`;
        });
        
        html += `</div>`;
    }
    
    const returnDate = document.getElementById('id_return_date').value;
    if (returnDate) {
        html += `<div class="mb-4">
            <strong class="text-gray-700">Ng√†y tr·∫£:</strong><br>
            <span class="text-gray-900">${new Date(returnDate).toLocaleString('vi-VN')}</span>
        </div>`;
    }
    
    document.getElementById('summaryPanel').innerHTML = html;
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    const hasReader = selectedReader !== null;
    const hasBooks = selectedBooks.length > 0;
    const hasDate = document.getElementById('id_return_date').value;
    
    submitBtn.disabled = !(hasReader && hasBooks && hasDate);
}

function loadReturnHistory(filter = 'all') {
    const historyList = document.getElementById('historyList');
    
    fetch("{% url 'return_book_list' %}?filter=" + filter, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const tableBody = doc.querySelector('tbody');
            
            if (tableBody && tableBody.innerHTML.trim()) {
                historyList.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Phi·∫øu #</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">ƒê·ªôc gi·∫£</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">S√°ch</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Ng√†y tr·∫£</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Ti·ªÅn ph·∫°t</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                `;
                
                const rows = doc.querySelectorAll('tbody tr');
                let historyBody = document.getElementById('historyBody');
                rows.forEach(row => {
                    const clonedRow = row.cloneNode(true);
                    clonedRow.classList.add('hover:bg-gray-50');
                    historyBody.appendChild(clonedRow);
                });
            } else {
                historyList.innerHTML = '<div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
            }
        })
        .catch(error => {
            historyList.innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded">L·ªói t·∫£i d·ªØ li·ªáu</div>`;
        });
}

// Form submit loading
document.getElementById('returnForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('submitBtn');
    const btnText = document.getElementById('submitBtnText');
    const btnLoading = document.getElementById('submitBtnLoading');
    
    if (btn && btnText && btnLoading) {
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
    }
});
</script>
{% endblock %}
