{% extends 'base.html' %} {% load static %} {% block title %}{{ page_title }}{%endblock %} {% block content %}
<!-- Page Header -->
{% comment %}
<div class="mb-8">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">Tiếp nhận sách mới</h1>
  <p class="text-gray-500">YC2 - Nhập sách vào thư viện</p>
</div>
{% endcomment %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 mb-6">
  <div class="p-6">
    <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-2">{{ page_title }}</h1>

    <p class="text-gray-500">Nhập sách vào thư viện</p>

    {% comment %} <div
      class="bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 text-blue-700 dark:text-blue-400 p-4 rounded mb-6 mt-4"
    >
      <p>
        <strong>Quy định (QĐ2):</strong> Chỉ nhận sách xuất bản từ năm
        <strong>{{ min_year }}</strong> trở đi. Phải có thể loại, ít nhất 1 tác
        giả, và nhà xuất bản.
      </p>
    </div> {% endcomment %}
  </div>
</div>

<!-- Import Method Selection -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mb-6 overflow-hidden">
  <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
    <h5 class="font-semibold">Chọn phương thức nhập</h5>
  </div>
  <div class="p-6">
    <div class="flex gap-4 justify-center">
      <button
        type="button"
        id="btn-manual-import"
        class="hover:scale-105 duration-200 transition-all bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg"
      >
        Nhập thủ công
      </button>
      <a
        href="{% url 'book_import_excel' %}"
        id="btn-excel-import"
        class="hover:scale-105 duration-200 transition-all bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg"
      >
        Nhập từ Excel
      </a>
    </div>
  </div>
</div>

<!-- Form Wrapper - Hidden by default until user selects manual import -->
<div id="manual-import-form" class="hidden">

<!-- Form Card -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 mb-6 overflow-hidden">
  <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
    <h5 class="font-semibold">Thông tin sách</h5>
  </div>
  <div class="p-6">

    <form method="post">
      {% csrf_token %}

      <!-- Messages -->
      {% comment %} {% if messages %} {% for message in messages %}
      <div
        class="{% if message.tags == 'success' %}bg-green-50 border-l-4 border-green-500 text-green-700{% elif message.tags == 'error' %}bg-red-50 border-l-4 border-red-500 text-red-700{% else %}bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 text-blue-700 dark:text-blue-400{% endif %} p-4 rounded mb-4"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endcomment %}

      <!-- Book Title -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
          >{{ form.book_title.label }}
          <span class="text-red-500">*</span></label
        >
        {{ form.book_title }}
      </div>

      <!-- Row: Category, Publisher -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.category.label }}
            <span class="text-red-500">*</span></label
          >
          {{ form.category }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.publisher.label }}
            <span class="text-red-500">*</span></label
          >
          {{ form.publisher }}
        </div>
      </div>

      <!-- Row: Year, Language, ISBN, Edition -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.publish_year.label }}
            <span class="text-red-500">*</span></label
          >
          {{ form.publish_year }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.language.label }}</label
          >
          {{ form.language }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.isbn.label }}</label
          >
          {{ form.isbn }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.edition.label }}</label
          >
          {{ form.edition }}
        </div>
      </div>

      <!-- Authors -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
          >{{ form.authors.label }}</label
        >
        <!-- Original select (hidden via JS after init) -->
        <div id="author-wrapper-fallback">
            {{ form.authors }} 
        </div>
        
        <!-- Helper for New Authors (Merged) -->
        <div id="div_id_new_authors" class="hidden">
            {{ form.new_authors }}
        </div>
        <!-- Hidden inputs for reliable syncing -->
        <input type="hidden" name="author_ids" id="author_ids_hidden" value="">
        <input type="hidden" name="new_author_names" id="new_author_names_hidden" value="">


      </div>

      <!-- Description -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
          >{{ form.description.label }}</label
        >
        {{ form.description }}
      </div>
      
      </div> <!-- End of first P-6 -->
    
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 mb-6 overflow-hidden">
      <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
        <h3 class="font-semibold text-lg">
          Thông tin nhập kho
        </h3>
      </div>
    
      <div class="p-6">

      <!-- Row: Quantity, Price, Date -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.quantity.label }}
            <span class="text-red-500">*</span></label
          >
          {{ form.quantity }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.unit_price.label }}
            <span class="text-red-500">*</span></label
          >
          {{ form.unit_price }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >{{ form.import_date.label }}
            <span class="text-red-500">*</span></label
          >
          {{ form.import_date }}
        </div>
      </div>

      <!-- Notes -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
          >{{ form.notes.label }}</label
        >
        {{ form.notes }}
      </div>
    </div>
    </div>
    <!-- Buttons -->
    <div class="flex gap-3 justify-center">
      <button
        type="submit"
        class="hover:scale-105 duration-200 transition-transform  bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"

        >
          Lưu phiếu nhập
        </button>
        <a
          href="{% url 'book_import_list' %}"
          class="hover:scale-105 duration-200 transition-transform bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors"
        >
          Xem danh sách
        </a>

        {% comment %}
        <a
          href="{% url 'home' %}"
          class="border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:bg-gray-700 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium py-2 px-4 rounded-lg transition-colors"
        >
          Về trang chủ
        </a>
        {% endcomment %}
      </div>
    </form>
  </div>
</div>
</div> <!-- End of manual-import-form wrapper -->

  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

  <style>
      /* Fix Tom Select Dark Mode */
      .ts-control {
          border-radius: 0.5rem;
          padding: 0.5rem;
      }
      .dark .ts-control {
          background-color: #374151;
          border-color: #4b5563;
          color: #f3f4f6;
      }
      .dark .ts-control input {
          color: #f3f4f6;
      }
      .dark .ts-dropdown {
          background-color: #374151;
          color: #f3f4f6;
          border-color: #4b5563;
      }
      .dark .ts-dropdown .active {
          background-color: #4b5563;
          color: #fff;
      }
      .dark .ts-dropdown .option:hover {
          background-color: #4b5563;
      }
  </style>

  <script>
  // Global variable to store Tom Select instance
  let tomSelectInstance = null;
  let originalContainer = null;

  document.addEventListener('DOMContentLoaded', function() {
      // Import method toggle
      const btnManual = document.getElementById('btn-manual-import');
      const btnExcel = document.getElementById('btn-excel-import');
      const formWrapper = document.getElementById('manual-import-form');

      if (btnManual && formWrapper) {
          btnManual.addEventListener('click', function() {
              // Show the form
              formWrapper.classList.remove('hidden');
              
              // Update button styles - Manual selected
              btnManual.className = 'hover:scale-105 duration-200 transition-all bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg ring-2 ring-blue-400 ring-offset-2 dark:ring-offset-gray-800';
              
              // Dim Excel button
              if (btnExcel) {
                  btnExcel.className = 'hover:scale-105 duration-200 transition-all bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 px-6 rounded-lg';
              }

              // Scroll to form
              formWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
      }

      // Initialize Tom Select
      const authorSettings = {
          plugins: ['remove_button', 'checkbox_options'],
          create: true,
          createOnBlur: true,
          persist: false,
          maxItems: null,
          valueField: 'value',
          labelField: 'text',
          searchField: 'text',
          placeholder: 'Chọn hoặc nhập tên tác giả mới...',
          render: {
              option_create: function(data, escape) {
                  return '<div class="create">Thêm tác giả mới <strong>' + escape(data.input) + '</strong>...</div>';
              }
          },
          create: function(input) {
              return {
                  value: 'new_' + input,
                  text: input
              }
          }
      };
      
      const options = [];
      const items = [];
      originalContainer = document.getElementById('id_authors');
      
      if (originalContainer) {
          // If it's a SELECT (SelectMultiple), extract options
          if (originalContainer.tagName === 'SELECT') {
              Array.from(originalContainer.options).forEach(opt => {
                 options.push({value: opt.value, text: opt.text});
                 if (opt.selected) items.push(opt.value);
              });
              // Hide original but don't disable it
              originalContainer.classList.add('hidden');
          } else {
              // Fallback for checkboxes if ever reverted
              const checkboxes = originalContainer.querySelectorAll('input[type="checkbox"]');
              if (checkboxes.length > 0) {
                  checkboxes.forEach(cb => {
                      const label = originalContainer.querySelector('label[for="' + cb.id + '"]');
                      const text = label ? label.innerText.trim() : cb.value;
                      options.push({value: cb.value, text: text});
                      if (cb.checked) items.push(cb.value);
                  });
              } else {
                  // Last resort: search globally if ID container failed
                  const inputs = document.getElementsByName('authors');
                  Array.from(inputs).forEach(input => {
                      if(input.type !== 'checkbox') return;
                      let text = input.value;
                      if (input.id) {
                          const label = document.querySelector('label[for="' + input.id + '"]');
                          if (label) text = label.innerText.trim();
                      } else if (input.parentNode.tagName === 'LABEL') {
                          text = input.parentNode.innerText.trim();
                      }
                      options.push({value: input.value, text: text});
                      if (input.checked) items.push(input.value);
                  });
              }
              originalContainer.classList.add('hidden');
          }
          
          // Create dummy input for Tom Select
          const tsInput = document.createElement('input');
          tsInput.id = 'tom-select-authors';
          
          // Insert after label or before original container
          const label = document.querySelector('label[for="id_authors"]') || originalContainer.previousElementSibling;
          if (label) {
              label.parentNode.insertBefore(tsInput, originalContainer);
          } else {
              originalContainer.parentNode.insertBefore(tsInput, originalContainer);
          }
          
          // Init Tom Select
          tomSelectInstance = new TomSelect(tsInput, {
              ...authorSettings,
              options: options,
              items: items
          });
          
          // Hide the visual container but keep the input functional
          const newAuthorsRow = document.getElementById('div_id_new_authors');
          if (newAuthorsRow) newAuthorsRow.classList.add('hidden');
          // Keep id_new_authors as text input (not hidden) so it can be submitted
          // Just hide it visually via parent container
      }

      // HANDLE FORM SUMBIT
      const form = document.querySelector('form');
      if (form) {
          form.addEventListener('submit', function(e) {
              // Basic Validation for Quantity/Price
              const quantityField = document.querySelector('input[name="quantity"]');
              console.log('DEBUG: Quantity field value before validation:', quantityField ? quantityField.value : 'not found');
              if (quantityField) {
                  const qtyValue = quantityField.value.trim();
                  if (!qtyValue || isNaN(qtyValue) || parseInt(qtyValue) < 1) {
                      console.log('DEBUG: Setting quantity to 1 (was:', qtyValue, ')');
                      quantityField.value = '1';
                  }
              }
              const unitPriceField = document.querySelector('input[name="unit_price"]');
              console.log('DEBUG: Unit price field value before validation:', unitPriceField ? unitPriceField.value : 'not found');
              if (unitPriceField) {
                  const priceValue = unitPriceField.value.trim();
                  if (!priceValue || isNaN(priceValue) || parseInt(priceValue) < 0) {
                      console.log('DEBUG: Setting unit price to 0 (was:', priceValue, ')');
                      unitPriceField.value = '0';
                  }
              }

              // SYNC AUTHORS
              if (tomSelectInstance && originalContainer) {
                  let values = tomSelectInstance.getValue(); // IDs or "new_Name"
                  
                  // Convert to array if it's not already
                  if (!Array.isArray(values)) {
                      values = values ? [values] : [];
                  }
                  
                  const existingIds = [];
                  const newNames = [];
                  
                  console.log('DEBUG: Raw values from Tom Select:', values);
                  
                  // Separate existing IDs vs New Names
                  values.forEach(val => {
                      const valStr = String(val); // Force string comparison
                      if (valStr.startsWith('new_')) {
                          newNames.push(valStr.substring(4));
                      } else {
                          // Allow loose check for IDs
                          existingIds.push(valStr); 
                      }
                  });
                  
                  // Sync to hidden SELECT
                  if (originalContainer.tagName === 'SELECT') {
                      // Reset selection
                      Array.from(originalContainer.options).forEach(opt => opt.selected = false);
                      
                      // Select matching IDs
                      existingIds.forEach(id => {
                          for (let i = 0; i < originalContainer.options.length; i++) {
                              if (String(originalContainer.options[i].value) === String(id)) {
                                  originalContainer.options[i].selected = true;
                                  break;
                              }
                          }
                      });
                  } else {
                      // Fallback Sync for checkboxes
                      const checkboxes = originalContainer.querySelectorAll('input[type="checkbox"]');
                      checkboxes.forEach(cb => {
                          cb.checked = existingIds.includes(cb.value);
                      });
                       // Double check by name if container query failed
                       if (checkboxes.length === 0) {
                           const inputs = document.getElementsByName('authors');
                           Array.from(inputs).forEach(input => {
                               if(input.type === 'checkbox') {
                                   input.checked = existingIds.includes(input.value);
                               }
                           });
                       }
                  }
                  
                  // Sync New Names to the actual form field 'new_authors'
                  const newAuthorsInput = document.getElementById('id_new_authors');
                  if (newAuthorsInput) {
                      newAuthorsInput.value = newNames.join(', ');
                      console.log('DEBUG: Synced new_authors input:', newAuthorsInput.value);
                  }
                  
                  // Debug: Check what's being synced
                  console.log('DEBUG: Existing author IDs:', existingIds);
                  console.log('DEBUG: New author names:', newNames);
                  console.log('DEBUG: Original SELECT selected:', 
                      Array.from(originalContainer.selectedOptions || []).map(o => o.value));
              }
              // Normal submit proceeds now
          });
      }
  });

  </script>
{% endblock %}
