{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mb-6">
    <div class="p-6">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-2">
            {{ page_title }}
        </h1>
        <p class="text-gray-500">Chỉnh sửa thông tin sách trong thư viện</p>
    </div>
</div>

<!-- Form chỉnh sửa -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 mb-6 overflow-hidden">
    <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3 flex justify-between items-center">
        <h5 class="font-semibold">Thông tin sách</h5>
        <span class="bg-white/20 text-white text-sm font-medium px-3 py-1 rounded-full">
            Mã Sách: {{ book.id }}
        </span>
    </div>
    <div class="p-6">
        <form method="POST">
            {% csrf_token %}
            
            <!-- Thông tin tựa sách -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <h6 class="font-semibold text-blue-600 mb-4 dark:text-blue-400">Thông tin tựa sách</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Tên sách (readonly) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên sách</label>
                        <input type="text" value="{{ book.book_title.book_title }}" class="form-control bg-gray-100 dark:bg-gray-600 dark:text-gray-200" readonly>
                    </div>

                    <!-- Thể loại (dropdown) -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Thể loại <span class="text-red-500">*</span>
                        </label>
                        <select name="category" id="category" class="form-control w-full">
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if cat.id == book.book_title.category.id %}selected{% endif %}>
                                    {{ cat.category_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Tác giả (multi-select với TomSelect) -->
                    <div class="md:col-span-2">
                        <label for="authors" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Tác giả <span class="text-red-500">*</span>
                        </label>
                        <select name="authors" id="authors" multiple class="form-control w-full">
                            {% for author in all_authors %}
                                <option value="{{ author.id }}" {% if author in book.book_title.authors.all %}selected{% endif %}>
                                    {{ author.author_name }}
                                </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="new_author_names" id="new_author_names_hidden" value="">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Có thể chọn nhiều tác giả hoặc nhập tên mới</p>
                    </div>
                    
                    <!-- Mô tả sách -->
                    <div class="md:col-span-2">
                        <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Mô tả sách <span class="text-gray-400 text-xs">(tùy chọn)</span>
                        </label>
                        <textarea name="description" id="description" rows="3" 
                            class="form-control w-full" 
                            placeholder="Nhập mô tả về nội dung sách...">{{ book.book_title.description|default:"" }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Số lượng -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <h6 class="font-semibold text-green-600 mb-4 dark:text-green-400">Thông tin số lượng</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.quantity.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Số lượng tổng <span class="text-red-500">*</span>
                        </label>
                        {{ form.quantity }}
                        <p class="text-gray-500 text-xs mt-1">Tổng số cuốn sách trong thư viện</p>
                    </div>
                    <div>
                        <label for="{{ form.remaining_quantity.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Số lượng còn lại <span class="text-red-500">*</span>
                        </label>
                        {{ form.remaining_quantity }}
                        <p class="text-gray-500 text-xs mt-1">Số cuốn còn sẵn sàng cho mượn</p>
                    </div>
                </div>
            </div>
            
            <!-- Thông tin xuất bản -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <h6 class="font-semibold text-purple-600 mb-4 dark:text-purple-400">Thông tin xuất bản</h6>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="unit_price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Đơn giá (VNĐ) <span class="text-red-500">*</span>
                        </label>
                        <input type="number" name="unit_price" id="unit_price" 
                            value="{{ book.unit_price }}" min="0" step="1000"
                            class="form-control w-full">
                    </div>
                    <div>
                        <label for="publish_year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Năm xuất bản <span class="text-red-500">*</span>
                        </label>
                        <input type="number" name="publish_year" id="publish_year" 
                            value="{{ book.publish_year }}" min="1900" max="2100"
                            class="form-control w-full">
                    </div>
                    <div>
                        <label for="publisher_select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Nhà xuất bản <span class="text-red-500">*</span>
                        </label>
                        <!-- TomSelect will replace this -->
                        <select id="publisher_select" class="hidden">
                            {% for pub in existing_publishers %}
                            <option value="{{ pub }}" {% if pub == book.publisher %}selected{% endif %}>{{ pub }}</option>
                            {% endfor %}
                        </select>
                        <!-- Hidden input to submit the actual value -->
                        <input type="hidden" name="publisher" id="publisher_hidden" value="{{ book.publisher }}">
                    </div>
                </div>
            </div>
            
            <!-- Thông tin bổ sung -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <h6 class="font-semibold text-blue-600 mb-4 dark:text-blue-400">Thông tin bổ sung</h6>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.isbn.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            ISBN
                        </label>
                        {{ form.isbn }}
                    </div>
                    <div>
                        <label for="{{ form.edition.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Phiên bản
                        </label>
                        {{ form.edition }}
                    </div>
                    <div>
                        <label for="{{ form.language.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Ngôn ngữ
                        </label>
                        {{ form.language }}
                    </div>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="flex flex-wrap justify-center gap-3 mt-6">
                <a href="{% url 'book_detail' book.id %}" class="hover:scale-105 duration-200 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                    Hủy
                </a>
                <button type="submit" class="hover:scale-105 duration-200 bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all">
                    Lưu thay đổi
                </button>
                {% if can_delete_book %}
                <a href="{% url 'book_delete' book.id %}" class="hover:scale-105 duration-200 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-all">
                    Xoá sách
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- TomSelect for Authors -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<style>
    /* Fix Tom Select Dark Mode */
    .ts-control {
        border-radius: 0.5rem;
        padding: 0.5rem;
    }
    .dark .ts-control {
        background-color: #374151;
        border-color: #4b5563;
        color: #f3f4f6;
    }
    .dark .ts-control input {
        color: #f3f4f6;
    }
    .dark .ts-dropdown {
        background-color: #374151;
        color: #f3f4f6;
        border-color: #4b5563;
    }
    .dark .ts-dropdown .active {
        background-color: #4b5563;
        color: #fff;
    }
    .dark .ts-dropdown .option:hover {
        background-color: #4b5563;
    }
</style>

<script>
let authorSelectInstance = null;
let publisherSelectInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize TomSelect for Authors
    const authorSelect = document.getElementById('authors');
    if (authorSelect) {
        authorSelectInstance = new TomSelect(authorSelect, {
            plugins: ['remove_button', 'checkbox_options'],
            create: true,
            createOnBlur: true,
            persist: false,
            maxItems: null,
            placeholder: 'Chọn hoặc thêm tác giả mới...',
            render: {
                option_create: function(data, escape) {
                    return '<div class="create">Thêm tác giả mới <strong>' + escape(data.input) + '</strong>...</div>';
                }
            },
            create: function(input) {
                return {
                    value: 'new_' + input,
                    text: input
                }
            }
        });
    }
    
    // Initialize TomSelect for Publisher
    const publisherSelect = document.getElementById('publisher_select');
    if (publisherSelect) {
        var pubOptions = [];
        Array.from(publisherSelect.options).forEach(function(opt) {
            pubOptions.push({value: opt.value, text: opt.text});
        });
        
        // Get current value from hidden input
        var currentPublisher = document.getElementById('publisher_hidden').value;
        
        // Create input for TomSelect
        var pubInput = document.createElement('input');
        pubInput.id = 'tom-select-publisher';
        pubInput.placeholder = 'Chọn hoặc nhập nhà xuất bản mới...';
        publisherSelect.parentNode.insertBefore(pubInput, publisherSelect);
        
        publisherSelectInstance = new TomSelect(pubInput, {
            plugins: ['remove_button'],
            create: true,
            createOnBlur: true,
            persist: true,
            maxItems: 1,
            valueField: 'value',
            labelField: 'text',
            searchField: 'text',
            options: pubOptions,
            items: currentPublisher ? [currentPublisher] : [],
            render: {
                option_create: function(data, escape) {
                    return '<div class="create">Thêm NXB mới <strong>' + escape(data.input) + '</strong>...</div>';
                }
            },
            create: function(input) {
                return {
                    value: input,
                    text: input
                }
            }
        });
    }
    
    // Handle form submit - sync authors and publisher
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Sync Authors
            if (authorSelectInstance) {
                var selectedItems = authorSelectInstance.items;
                var existingIds = [];
                var newNames = [];
                
                selectedItems.forEach(function(val) {
                    val = String(val).trim();
                    if (!val) return;
                    
                    if (val.indexOf('new_') === 0) {
                        var authorName = val.substring(4).trim();
                        if (authorName) {
                            newNames.push(authorName);
                        }
                    } else {
                        existingIds.push(val);
                    }
                });
                
                // Update hidden input for new authors
                var newAuthorNamesHidden = document.getElementById('new_author_names_hidden');
                if (newAuthorNamesHidden) {
                    newAuthorNamesHidden.value = newNames.join('|||');
                }
            }
            
            // Sync Publisher
            if (publisherSelectInstance) {
                var pubValue = publisherSelectInstance.getValue();
                var publisherHidden = document.getElementById('publisher_hidden');
                if (publisherHidden) {
                    publisherHidden.value = pubValue || '';
                }
            }
        });
    }
});
</script>
{% endblock %}
