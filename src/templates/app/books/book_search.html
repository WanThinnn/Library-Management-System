{% extends 'base.html' %}

{% block title %}Tra cứu sách{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 2rem;">
    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Tra cứu sách</h1>
    <p style="color: var(--text-secondary);">BM3 - Danh Sách Sách</p>
</div>

<!-- Search Card -->
<div class="card card-glass" style="margin-bottom: 2rem;">
    <div class="card-body">
        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Tiêu chí tìm kiếm</h3>
        <form method="get">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    {{ form.search_text }}
                </div>
                <div class="form-group">
                    {{ form.category }}
                </div>
                <div class="form-group">
                    {{ form.author }}
                </div>
                <div class="form-group">
                    {{ form.status }}
                </div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">
                    Tìm kiếm
                </button>
                <a href="{% url 'book_search' %}" class="btn btn-outline">
                    Xóa lọc
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Results -->
{% if total_results > 0 %}
<div class="alert alert-info" style="margin-bottom: 2rem;">
    Tìm thấy <strong>{{ total_results }}</strong> kết quả
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã Sách</th>
                    <th>Tên Sách</th>
                    <th>Thể Loại</th>
                    <th>Tác Giả</th>
                    <th>Số Lượng Còn</th>
                    <th>Tình Trạng</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><code style="background: var(--surface-secondary); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ book.id }}</code></td>
                    <td>
                        <strong>{{ book.book_title.book_title }}</strong>
                        {% if book.book_title.isbn %}
                        <br>
                        <small style="color: var(--text-secondary);">ISBN: {{ book.book_title.isbn }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge" style="background: var(--gradient-blue); color: white;">{{ book.category.category_name }}</span>
                    </td>
                    <td>
                        {% for author in book.book_title.authors.all %}
                            <span class="badge" style="background: var(--surface-secondary); color: var(--text-primary);">{{ author.author_name }}</span>
                            {% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        <strong>{{ book.remaining_quantity }}</strong> / {{ book.quantity }}
                    </td>
                    <td>
                        {% if book.remaining_quantity > 0 %}
                            <span class="badge" style="background: var(--success); color: white;">Còn sách</span>
                        {% else %}
                            <span class="badge" style="background: var(--error); color: white;">Hết sách</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination" style="margin-top: 2rem;">
    {% if page_obj.has_previous %}
    <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-link">
        Đầu tiên
    </a>
    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-link">
        Trước
    </a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <span class="pagination-link active">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-link">
            {{ num }}
        </a>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-link">
        Tiếp
    </a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-link">
        Cuối
    </a>
    {% endif %}
</div>
{% endif %}

{% elif request.GET %}
<!-- No results -->
<div class="alert alert-warning">
    <strong>Không tìm thấy sách phù hợp với tiêu chí tìm kiếm.</strong>
    <p style="margin-top: 0.5rem;">Vui lòng thử lại với tiêu chí khác hoặc <a href="{% url 'book_search' %}" style="color: var(--warning); text-decoration: underline;">xóa lọc</a>.</p>
</div>
{% else %}
<!-- Start search -->
<div class="alert alert-info">
    <strong>Nhập tiêu chí tìm kiếm ở trên để bắt đầu.</strong>
</div>
{% endif %}
{% endblock %}
