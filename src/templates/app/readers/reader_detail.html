{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white rounded-lg shadow-md border border-gray-200 mb-6">
    <div class="p-6">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
            üé´ {{ page_title }}
        </h1>
        <p class="text-gray-500">Chi ti·∫øt th√¥ng tin th·∫ª ƒë·ªôc gi·∫£</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column - Main Info -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Th√¥ng tin th·∫ª ƒë·ªôc gi·∫£ -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold mb-4 border-b border-white/30 pb-2">
                üìá TH√îNG TIN TH·∫∫ ƒê·ªòC GI·∫¢
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-white/80 text-sm">M√£ ƒë·ªôc gi·∫£:</p>
                    <p class="text-2xl font-bold">{{ reader.id }}</p>
                </div>
                <div>
                    <p class="text-white/80 text-sm">Lo·∫°i ƒë·ªôc gi·∫£:</p>
                    <p class="text-xl font-semibold">{{ reader.reader_type.reader_type_name }}</p>
                </div>
            </div>
        </div>

        <!-- Th√¥ng tin c√° nh√¢n -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div class="bg-blue-600 text-white px-4 py-3">
                <h5 class="font-semibold">üë§ Th√¥ng tin c√° nh√¢n</h5>
            </div>
            <div class="p-4">
                <table class="w-full">
                    <tbody class="divide-y divide-gray-200">
                        <tr>
                            <td class="py-3 font-semibold text-gray-700" style="width: 150px;">H·ªç v√† t√™n:</td>
                            <td class="py-3 text-gray-900">{{ reader.reader_name }}</td>
                        </tr>
                        <tr>
                            <td class="py-3 font-semibold text-gray-700">Ng√†y sinh:</td>
                            <td class="py-3 text-gray-900">
                                {{ reader.date_of_birth|date:"d/m/Y" }}
                                <span class="text-gray-500">({{ reader.age }} tu·ªïi)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="py-3 font-semibold text-gray-700">Email:</td>
                            <td class="py-3 text-gray-900">{{ reader.email }}</td>
                        </tr>
                        <tr>
                            <td class="py-3 font-semibold text-gray-700">ƒê·ªãa ch·ªâ:</td>
                            <td class="py-3 text-gray-900">{{ reader.address|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- S√°ch ƒëang m∆∞·ª£n -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div class="bg-amber-500 text-white px-4 py-3">
                <h5 class="font-semibold">S√°ch ƒëang m∆∞·ª£n</h5>
            </div>
            <div class="p-4" id="readerBorrowingList">
                <div class="text-center text-gray-500 py-8">
                    <div class="animate-spin inline-block w-6 h-6 border-2 border-current border-t-transparent rounded-full mb-2"></div>
                    <p>ƒêang t·∫£i danh s√°ch...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Card Info & Actions -->
    <div class="space-y-6">
        <!-- Th√¥ng tin th·∫ª -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div class="bg-blue-600 text-white px-4 py-3">
                <h5 class="font-semibold">üìÖ Th√¥ng tin th·∫ª th∆∞ vi·ªán</h5>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <p class="text-gray-500 text-sm">Ng√†y l·∫≠p th·∫ª:</p>
                    <p class="text-lg font-semibold text-gray-900">{{ reader.card_creation_date|date:"d/m/Y" }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Ng√†y h·∫øt h·∫°n:</p>
                    <p class="text-lg font-semibold text-gray-900">
                        {{ reader.expiration_date|date:"d/m/Y" }}
                        {% if reader.is_card_expired %}
                            <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-2">H·∫æT H·∫†N</span>
                        {% else %}
                            <span class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full ml-2">C√íN H·∫†N</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Tr·∫°ng th√°i:</p>
                    {% if reader.is_active %}
                        <span class="bg-green-500 text-white text-sm px-3 py-1 rounded-full">‚úÖ ƒêang ho·∫°t ƒë·ªông</span>
                    {% else %}
                        <span class="bg-red-500 text-white text-sm px-3 py-1 rounded-full">ƒê√£ kh√≥a</span>
                    {% endif %}
                </div>
                <div>
                    <p class="text-gray-500 text-sm">T·ªïng n·ª£:</p>
                    <p class="text-2xl font-bold {% if reader.total_debt > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ reader.total_debt|floatformat:0|default:"0" }}ƒë
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div class="bg-blue-600 text-white px-4 py-3">
                <h5 class="font-semibold">‚öôÔ∏è Thao t√°c</h5>
            </div>
            <div class="p-4 space-y-2">
                <a href="{% url 'reader_create' %}" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                    L·∫≠p th·∫ª ƒë·ªôc gi·∫£ kh√°c
                </a>
                <a href="{% url 'reader_list' %}" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                     Danh s√°ch ƒë·ªôc gi·∫£
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function loadReaderBorrowingInfo() {
    const readerId = {{ reader.id }};
    
    fetch("{% url 'api_borrowing_readers' %}")
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => {
            const container = document.getElementById('readerBorrowingList');
            
            // T√¨m ƒë·ªôc gi·∫£ hi·ªán t·∫°i trong danh s√°ch
            const readerData = data.data?.find(r => r.reader_id == readerId);
            
            if (!readerData) {
                container.innerHTML = '<div class="text-center text-green-600 py-4"><em>ƒê·ªôc gi·∫£ kh√¥ng c√≥ s√°ch m∆∞·ª£n</em></div>';
            } else {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let booksHtml = readerData.books.map(book => {
                    const [day, month, year] = book.due_date.split('/');
                    const dueDate = new Date(year, month - 1, day);
                    const isOverdue = dueDate < today;
                    
                    return `
                        <tr class="${isOverdue ? 'bg-red-50' : ''} hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm"><strong>${book.title}</strong></td>
                            <td class="px-3 py-2 text-sm text-gray-600">${book.borrow_date}</td>
                            <td class="px-3 py-2 text-sm text-gray-600">${book.due_date}</td>
                            <td class="px-3 py-2 text-sm">
                                ${isOverdue ? 
                                    '<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">Qu√° h·∫°n</span>' : 
                                    '<span class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full">C√≤n h·∫°n</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-4 p-3 bg-amber-50 rounded-lg">
                        <div>
                            <p class="text-amber-700 text-sm font-medium">T·ªïng s√°ch ƒëang m∆∞·ª£n:</p>
                            <p class="text-2xl font-bold text-blue-600">${readerData.borrowed_count} quy·ªÉn</p>
                        </div>
                        <div>
                            <p class="text-amber-700 text-sm font-medium">Ph·∫£i tr·∫£ tr∆∞·ªõc:</p>
                            <p class="text-lg font-bold ${readerData.is_overdue ? 'text-red-600' : 'text-green-600'}">
                                ${readerData.latest_due_date}
                                ${readerData.is_overdue ? ' ‚ö†Ô∏è' : ''}
                            </p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-amber-100">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">T√™n s√°ch</th>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Ng√†y m∆∞·ª£n</th>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Ph·∫£i tr·∫£</th>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${booksHtml}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading borrowing info:', error);
            document.getElementById('readerBorrowingList').innerHTML = '<div class="text-center text-red-600 py-4"><em>L·ªói t·∫£i th√¥ng tin m∆∞·ª£n s√°ch</em></div>';
        });
}

// Load data khi trang load
document.addEventListener('DOMContentLoaded', function() {
    loadReaderBorrowingInfo();
    
    // Refresh m·ªói 30 gi√¢y
    setInterval(loadReaderBorrowingInfo, 30000);
});
</script>
{% endblock %}
