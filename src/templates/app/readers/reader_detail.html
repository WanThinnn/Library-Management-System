{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 mb-6">
    <div class="p-6">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-2">
            {{ page_title }}
        </h1>
        <p class="text-gray-500">Chi tiết thông tin thẻ độc giả</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column - Main Info -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Thông tin thẻ độc giả -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold mb-4 border-b border-white/30 pb-2">
                THÔNG TIN THẺ ĐỘC GIẢ
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-white/80 text-sm">Mã độc giả:</p>
                    <p class="text-2xl font-bold">{{ reader.id }}</p>
                </div>
                <div>
                    <p class="text-white/80 text-sm">Loại độc giả:</p>
                    <p class="text-xl font-semibold">{{ reader.reader_type.reader_type_name }}</p>
                </div>
            </div>
        </div>

        <!-- Thông tin cá nhân -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 overflow-hidden">
            <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
                <h5 class="font-semibold">Thông tin cá nhân</h5>
            </div>
            <div class="p-4">
                <table class="w-full">
                    <tbody class="divide-y divide-gray-200">
                        <tr>
                            <td class="py-3 font-semibold text-gray-700 dark:text-gray-300" style="width: 150px;">Họ và tên:</td>
                            <td class="py-3 text-gray-900 dark:text-gray-100">{{ reader.reader_name }}</td>
                        </tr>
                        <tr>
                            <td class="py-3 font-semibold text-gray-700 dark:text-gray-300">Ngày sinh:</td>
                            <td class="py-3 text-gray-900 dark:text-gray-100">
                                {{ reader.date_of_birth|date:"d/m/Y" }}
                                <span class="text-gray-500">({{ reader.age }} tuổi)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="py-3 font-semibold text-gray-700 dark:text-gray-300">Email:</td>
                            <td class="py-3 text-gray-900 dark:text-gray-100">{{ reader.email }}</td>
                        </tr>
                        <tr>
                            <td class="py-3 font-semibold text-gray-700 dark:text-gray-300">Địa chỉ:</td>
                            <td class="py-3 text-gray-900 dark:text-gray-100">{{ reader.address|default:"Chưa cập nhật" }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sách đang mượn -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 overflow-hidden">
            <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
                <h5 class="font-semibold">Sách đang mượn</h5>
            </div>
            <div class="p-4" id="readerBorrowingList">
                <div class="text-center text-gray-500 py-8">
                    <div class="animate-spin inline-block w-6 h-6 border-2 border-current border-t-transparent rounded-full mb-2"></div>
                    <p>Đang tải danh sách...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Card Info & Actions -->
    <div class="space-y-6">
        <!-- Thông tin thẻ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 overflow-hidden">
            <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
                <h5 class="font-semibold">Thông tin thẻ thư viện</h5>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <p class="text-gray-500 text-sm">Ngày lập thẻ:</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">{{ reader.card_creation_date|date:"d/m/Y" }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Ngày hết hạn:</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                        {{ reader.expiration_date|date:"d/m/Y" }}
                        {% if reader.is_card_expired %}
                            <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-2 inline-block whitespace-nowrap">HẾT HẠN</span>
                        {% else %}
                            <span class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full ml-2 inline-block whitespace-nowrap">CÒN HẠN</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Trạng thái:</p>
                    {% if reader.is_active %}
                        <span class="bg-green-500 text-white text-sm px-3 py-1 rounded-full inline-block whitespace-nowrap">Đang hoạt động</span>
                    {% else %}
                        <span class="bg-red-500 text-white text-sm px-3 py-1 rounded-full inline-block whitespace-nowrap">Đã khóa</span>
                    {% endif %}
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Tổng nợ (gồm dự tính):</p>
                    <p class="text-2xl font-bold {% if reader.total_debt_with_pending > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ reader.total_debt_with_pending|floatformat:0|default:"0" }}đ
                    </p>
                    {% if reader.pending_debt > 0 %}
                    <small class="text-xs text-blue-600 dark:text-blue-300 block">
                        ({{ reader.total_debt|floatformat:0 }}đ đã chốt + {{ reader.pending_debt|floatformat:0 }}đ dự tính)
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 dark:border-gray-700 overflow-hidden">
            <div class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-3">
                <h5 class="font-semibold">Thao tác</h5>
            </div>
            <div class="p-4 space-y-2">
                {% if can_edit_readers %}
                <a href="{% url 'reader_edit' reader.id %}" class="hover:scale-105 duration-200 transition-transform w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    {% comment %} <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg> {% endcomment %}
                    Sửa thông tin
                </a>
                {% endif %}
                {% if can_delete_readers %}
                <a href="{% url 'reader_delete' reader.id %}" 
                   class="hover:scale-105 duration-200 transition-transform w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    Xóa độc giả
                </a>
                {% endif %}
                {% if can_add_readers %}
                <a href="{% url 'reader_create' %}" class="hover:scale-105 duration-200 transition-transform w-full bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    Lập thẻ độc giả khác
                </a>
                {% endif %}
                <a href="{% url 'reader_list' %}" class="hover:scale-105 duration-200 transition-transform w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    Danh sách độc giả
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function loadReaderBorrowingInfo() {
    const readerId = {{ reader.id }};
    
    fetch("{% url 'api_borrowing_readers' %}")
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => {
            const container = document.getElementById('readerBorrowingList');
            
            // Tìm độc giả hiện tại trong danh sách
            const readerData = data.data?.find(r => r.reader_id == readerId);
            
            if (!readerData) {
                container.innerHTML = '<div class="text-center text-green-600 py-4"><em>Độc giả không có sách mượn</em></div>';
            } else {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let booksHtml = readerData.books.map(book => {
                    const [day, month, year] = book.due_date.split('/');
                    const dueDate = new Date(year, month - 1, day);
                    const isOverdue = dueDate < today;
                    
                    return `
                        <tr class="${isOverdue ? 'bg-gray-700' : ''}  dark:bg-gray-700 dark:hover:bg-gray-700">
                            <td class="px-3 py-2 text-sm">
                                <a href="/book/${book.id}/" class="text-blue-950 hover:text-blue-800 dark:text-blue-50 dark:hover:text-blue-300 font-semibold hover:underline">
                                    ${book.title}
                                </a>
                            </td>
                            <td class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400">${book.borrow_date}</td>
                            <td class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400">${book.due_date}</td>
                            <td class="px-3 py-2 text-sm">
                                ${isOverdue ? 
                                    '<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">Quá hạn</span>' : 
                                    '<span class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full">Còn hạn</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-4 p-3 bg-amber-50 rounded-lg">
                        <div>
                            <p class="text-amber-700 text-sm font-medium">Tổng sách đang mượn:</p>
                            <p class="text-2xl font-bold text-blue-600">${readerData.borrowed_count} quyển</p>
                        </div>
                        <div>
                            <p class="text-amber-700 text-sm font-medium">Phải trả trước:</p>
                            <p class="text-lg font-bold ${readerData.is_overdue ? 'text-red-600' : 'text-green-600'}">
                                ${readerData.latest_due_date}
                                ${readerData.is_overdue ? '' : ''}
                            </p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-amber-100">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Tên sách</th>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Ngày mượn</th>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Phải trả</th>
                                    <th class="px-3 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${booksHtml}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading borrowing info:', error);
            document.getElementById('readerBorrowingList').innerHTML = '<div class="text-center text-red-600 py-4"><em>Lỗi tải thông tin mượn sách</em></div>';
        });
}

// Load data khi trang load
document.addEventListener('DOMContentLoaded', function() {
    loadReaderBorrowingInfo();
    
    // Refresh mỗi 30 giây
    setInterval(loadReaderBorrowingInfo, 30000);
});
</script>
{% endblock %}
