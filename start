#!/bin/bash

# Library Management System - Deployment Script
# Usage: ./start [--prod|--dev] <command>

set -e

# Default to development
ENV="dev"
COMPOSE_FILE="docker-compose.yml"

# Parse environment flag
if [[ "$1" == "--prod" ]]; then
    ENV="prod"
    COMPOSE_FILE="docker-compose.prod.yml"
    shift
elif [[ "$1" == "--dev" ]]; then
    ENV="dev"
    COMPOSE_FILE="docker-compose.yml"
    shift
fi

# Get command
COMMAND="$1"
shift || true

# Color output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}[${ENV}]${NC} Running command: ${GREEN}${COMMAND}${NC}"

case "$COMMAND" in
    setup)
        bash scripts/setup.sh
        ;;
    
    build)
        if [[ "$ENV" == "prod" ]]; then
            docker compose -f "$COMPOSE_FILE" pull
            docker compose -f "$COMPOSE_FILE" build
        else
            docker compose -f "$COMPOSE_FILE" build
        fi
        ;;
    
    up|start)
        docker compose -f "$COMPOSE_FILE" up -d
        echo -e "${GREEN}[${ENV}] Services started.${NC} Access at https://library.cyberfortress.local"
        ;;
    
    down|stop)
        docker compose -f "$COMPOSE_FILE" down
        ;;
    
    restart)
        docker compose -f "$COMPOSE_FILE" restart
        ;;
    
    logs)
        docker compose -f "$COMPOSE_FILE" logs -f
        ;;
    
    makemigrations)
        docker compose -f "$COMPOSE_FILE" exec web python manage.py makemigrations "$@"
        ;;
    
    migrate)
        docker compose -f "$COMPOSE_FILE" exec web python manage.py migrate "$@"
        ;;
    
    initdata)
        docker compose -f "$COMPOSE_FILE" exec web python init_data.py
        ;;
    
    createsuperuser)
        docker compose -f "$COMPOSE_FILE" exec web python manage.py createsuperuser
        ;;
    
    shell)
        docker compose -f "$COMPOSE_FILE" exec web python manage.py shell
        ;;
    
    collectstatic)
        docker compose -f "$COMPOSE_FILE" exec web python manage.py collectstatic --noinput
        ;;
    
    clean)
        docker compose -f "$COMPOSE_FILE" down -v
        docker system prune -f
        ;;
    
    rebuild)
        docker compose -f "$COMPOSE_FILE" down
        docker compose -f "$COMPOSE_FILE" build --no-cache
        docker compose -f "$COMPOSE_FILE" up -d
        ;;
    
    help|--help|-h|"")
        echo "Library Management System - Deployment Script"
        echo ""
        echo "Usage: ./start [--prod|--dev] <command>"
        echo ""
        echo "Environment flags:"
        echo "  --dev           Use development environment (default)"
        echo "  --prod          Use production environment"
        echo ""
        echo "Commands:"
        echo "  setup           Initial setup (certificates, .env)"
        echo "  build           Build Docker images"
        echo "  up, start       Start all services"
        echo "  down, stop      Stop all services"
        echo "  restart         Restart all services"
        echo "  logs            View logs"
        echo "  makemigrations  Create new migrations"
        echo "  migrate         Run database migrations"
        echo "  initdata        Initialize sample data"
        echo "  createsuperuser Create Django superuser"
        echo "  shell           Open Django shell"
        echo "  collectstatic   Collect static files"
        echo "  clean           Remove containers and volumes"
        echo "  rebuild         Clean rebuild"
        echo "  help            Show this help"
        echo ""
        echo "Examples:"
        echo "  ./start build                 # Build development"
        echo "  ./start --prod build          # Build production"
        echo "  ./start --prod up             # Start production"
        echo "  ./start --dev migrate         # Run dev migrations"
        echo "  ./start logs                  # View dev logs"
        echo ""
        ;;
    
    *)
        echo -e "${YELLOW}Unknown command: $COMMAND${NC}"
        echo "Run './start help' for usage information"
        exit 1
        ;;
esac
