services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: django_app
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn LibraryManagementSystem.wsgi:application -c gunicorn.conf.py"
    volumes:
      - ./src:/app
      - ./docs:/docs
      - ./scripts/gunicorn.conf.py:/app/gunicorn.conf.py:ro
      - static_volume:/app/staticfiles
      - sqlite_volume:/app/data
      - ./scripts/init_data.py:/app/init_data.py:ro
      - ./src/LibraryApp/migrations:/app/LibraryApp/migrations

    expose:
      - "8000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/data/db.sqlite3}
      - PYTHONUNBUFFERED=1
      # Bank Account Configuration
      - BANK_ACCOUNT_NAME=${BANK_ACCOUNT_NAME:-THU VIEN TRUONG}
      - BANK_ACCOUNT_NO=${BANK_ACCOUNT_NO:-123456789}
      - BANK_ID=${BANK_ID:-970407}
      - BANK_TEMPLATE=${BANK_TEMPLATE:-print}
    depends_on:
      - nginx
    networks:
      - app-network
    restart: unless-stopped

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_server
    profiles:
      - ssl
    volumes:
      - static_volume:/app/staticfiles
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME:-library.cyberfortress.local}
      - SSL_CERT_FILE=${SSL_CERT_FILE:-_.cyberfortress.local.crt}
      - SSL_KEY_FILE=${SSL_KEY_FILE:-_.cyberfortress.local.key}
      - SSL_CA_FILE=${SSL_CA_FILE:-CyberFortress-RootCA.crt}
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    networks:
      - app-network
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared_tunnel
    command: tunnel --config /etc/cloudflared/config.yml run ${CLOUDFLARE_TUNNEL_ID}
    env_file:
      - .env
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    depends_on:
      - web
    networks:
      - app-network
    restart: unless-stopped
    profiles:
      - tunnel

volumes:
  static_volume:
  sqlite_volume:


networks:
  app-network:
    driver: bridge
